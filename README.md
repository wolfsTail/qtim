# users

Модуль `users` является реализацией системы регистрации и аутентификации пользователей. Обеспечивает эффективное управление данными пользователя и их взаимодействие с другими модулями системы.

- Основной функционал:
  - получение и обновление данных пользователя;
  - регистрация пользователей с верификацией телефонного номера;
  - аутентификация пользователей (JWT).
- Роль:
  - аутентификация и авторизация;
  - управление данными пользователя.
- Стэк:
  - NestJS;
  - TypeORM;
  - JWT;
  - NestJS Swagger;
  - class-validator;
  - class-transformer;
  - БД.

## Структура
```
users/
│
├── decorators/
│   └── user.payload.decorator.ts
│
├── dto/
│   ├── create.user.dto.ts
│   └── update.user.dto.ts
│
├── entities/
│   ├── phone.confirmation.entity.ts
│   └── user.entity.ts
│
├── enums/
│   └── userRoles.enum.ts
│
├── interfaces/
│   └── user.payload.interface.ts
│
├── users.controller.ts
├── users.module.ts
└── users.service.ts
```

## UsersModule

Модуль, отвечающий за управление функциональностью, связанной с пользователями в приложении.Обеспечивая единую точку взаимодействия для компонентов, работающих с данными пользователя.

### Компоненты

- **Controllers**:
  - `UsersController`: Обрабатывает входящие HTTP-запросы, связанные с пользователями, и делегирует операции сервису.

- **Providers**:
  - `UsersService`: Реализует логику при взаимодействии с базой данных.

## UsersService

Cервис, предоставляющий логику для управления пользователями в приложении при взаимодействии с БД, включая создание, обновление и аутентификацию пользователей.

### Методы

### `createUser`
- **Параметры**: `CreateUserDto`
- **Возвращает**: `Promise<PhoneConfirmation>`
- **Описание**: Создаёт нового пользователя и инициирует процесс подтверждения телефона.

### `updateUser`
- **Параметры**: `userId`, `UpdateUserDto`
- **Возвращает**: `Promise<UserEntity>`
- **Описание**: Обновляет данные существующего пользователя.

### `updatePhone`
- **Параметры**: `userId`, `phone`
- **Возвращает**: `Promise<UserEntity>`
- **Описание**: Обновляет телефонный номер пользователя и инициирует отправку SMS для подтверждения.

### `confirmPhone`
- **Параметры**: `phone`, `code`
- **Возвращает**: `Promise<{accessToken, refreshToken}>`
- **Описание**: Подтверждает телефонный номер и активирует пользователя, возвращая токены доступа.

### `sendPhoneConfirmation`
- **Параметры**: `userId`, `phone`
- **Возвращает**: `Promise<PhoneConfirmation>`
- **Описание**: Создаёт или обновляет запрос на подтверждение телефона, отправляя код подтверждения.

### `getProfile`
- **Параметры**: `UserPayloadInterface`
- **Возвращает**: `Promise<object>`
- **Описание**: Возвращает профиль пользователя, включая информацию о текущей компании, если доступна.

### `findOneById`
- **Параметры**: `id`
- **Возвращает**: `Promise<UserEntity>`
- **Описание**: Ищет пользователя по уникальному идентификатору.

### `findOneByPhone`
- **Параметры**: `phone`
- **Возвращает**: `Promise<UserEntity>`
- **Описание**: Ищет пользователя по телефонному номеру.

### Использование репозиториев

- `userRepository`: Для операций с сущностью `UserEntity`.
- `phoneConfirmationRepository`: Для операций с сущностью `PhoneConfirmation`.

### Взаимодействие с другими сервисами

- `CryptoService`: Генерирует коды для подтверждения мобильного телефона.
- `AuthService`: Управляет аутентификацией и выдачей токенов.
- `CompanyService`: Управляет данными о компаниях, связанных с пользователями.

## UsersController

Перечень контроллеров, обрабатывающие HTTP-запросы, связанные с операциями  доступными пользователям в приложении. Содержит маршруты, параметры и порядок взаимодействия со сторонними сервисами.

### Доступные методы

### `getProfile`
- **Route**: `GET /users/profile`
- **Guard**: `JwtAuthGuard` (Требуется аутентификация)
- **Описание**: Возвращает профиль текущего пользователя.

### `phoneConfirm`
- **Route**: `POST /users/phone-confirm/:code`
- **Параметры**:
  - `code`: Код подтверждения, преобразованный из строки в число.
  - `phone`: Телефонный номер из тела запроса.
- **Описание**: Подтверждает телефонный номер пользователя.

### `phoneResend`
- **Route**: `GET /users/phone-resend`
- **Guard**: `JwtAuthGuard` (Требуется аутентификация)
- **Описание**: Повторно отправляет подтверждение телефона текущему пользователю.

### `updateProfile`
- **Route**: `PUT /users/profile`
- **Guard**: `JwtAuthGuard` (Требуется аутентификация)
- **Параметры**:
  - `updateUserDto`: DTO для обновления данных пользователя.
- **Описание**: Обновляет профиль пользователя.

### `updatePhone`
- **Route**: `PUT /users/phone`
- **Guard**: `JwtAuthGuard` (Требуется аутентификация)
- **Параметры**:
  - `phone`: Новый телефонный номер пользователя.
- **Описание**: Обновляет телефонный номер пользователя.

### `signUp`
- **Route**: `POST /users/registration`
- **Параметры**:
  - `createUserDto`: DTO для регистрации нового пользователя.
- **Описание**: Регистрирует нового пользователя.

## UserEntity

Представление модели  пользователя - `UserEntity`, проецируемое по средствам ORM в базу данных. Описывает струтуру и взаимосвязи данной модели.

## Столбцы

- `id`: Уникальный идентификатор пользователя.
  - Присваивается автоматически.
  - Тип: UUID.

- `createdAt`: Дата создания записи пользователя.
  - Присваивается автоматически.

- `updatedAt`: Дата последнего обновления записи пользователя.
  - Присваивается автоматически.

- `active`: Статус активности пользователя.
  - Тип: `boolean`.
  - По умолчанию: `false`.

- `password`: Хэшированный пароль пользователя.
  - Из результатов запроса исключается.

- `firstname`: Имя пользователя.
  - Тип: `string`.

- `lastname`: Фамилия пользователя.
  - Тип: `string`.
  - Опциональное поле.

- `patronymic`: Отчество пользователя.
  - Тип: `string`.

- `birthday`: Дата рождения пользователя.
  - Опциональное поле.

- `phone`: Телефонный номер пользователя.
  - Тип: `string`.

- `phoneConfirm`: Статус подтверждения телефонного номера.
  - Тип: `boolean`.
  - По умолчанию: `false`.

- `jwtRefreshToken`: Связь с таблицей токенов обновления JWT.
  - Из результатов запроса исключается.

- `avatarId`: Идентификатор аватара пользователя.
  - Опциональное поле.
  - Тип: UUID.

- `avatar`: Связанная сущность аватара.

- `role`: Роль пользователя в системе.
  - Тип: `enum` (UserRoles).
  - По умолчанию: `USER`.

- `email`: Электронная почта пользователя.
  - Опциональное поле.

- `emailConfirm`: Статус подтверждения электронной почты.
  - Тип: `boolean`.
  - По умолчанию: `false`.

- `companies`: Связь с сущностями компаний, в которых пользователь является владельцем.
  - Загружается сразу (eager loading).

### Взаимосвязи

- Один ко многим с `JwtRefreshToken`.
- Один к одному с `Upload` для аватара.
- Один ко многим с `Company`.

## PhoneConfirmation

Представление модели `PhoneConfirmation`, используемое для хранения информации о подтверждениях телефона. Внешняя связь с моделью `UserEntity`.

### Столбцы

- `id`: Уникальный идентификатор записи подтверждения.
  - Присваивается автоматически.
  - Тип: UUID.

- `createdAt`: Дата и время создания записи подтверждения.
  - Присваивается автоматически.

- `updatedAt`: Дата и время последнего обновления записи.
  - Присваивается автоматически.

- `code`: Код подтверждения, который должен быть введён пользователем.
  - Тип: `number`.

- `phone`: Телефонный номер, который необходимо подтвердить.
  - Тип: `string`.

- `userId`: Идентификатор пользователя, который связан с процессом подтверждения.
  - Тип: UUID.
  - Может быть `null`, если подтверждение ещё не связано с пользователем.

### Взаимосвязи

- Один к одному (`OneToOne`) с `UserEntity`:
  - Каскадное удаление: при удалении пользователя, связанные с ним данные подтверждения также удаляются.

## UserPayloadInterface

Класс определяющий структуру данных пользователя, используемый при аутентификации и авторизации (скорее всего в payload JWT).

### Свойства класса

- `phone`: Телефонный номер пользователя.
  - Тип: `string`.

- `id`: Уникальный идентификатор пользователя.
  - Тип: `string`.

- `companyId`: Идентификатор компании, с которой связан пользователь.
  - Тип: `string`.

## UserRoles

Перечисление (enum), определяющее роль пользователя в системе. Используется при аутентификации и авторизации в системе.

### Доступные роли

- `ADMIN`: Администратор системы. 

- `MANAGER`: Менеджер (руководитель).

- `USER`: Базовый пользователь. 

## CreateUserDto

Содержит Data Transfer Object, который используется при инициализации сущности нового пользователя.

### Свойства класса

- `firstname`: Имя пользователя.
  - Тип: `string`
  - Минимальная длина: 2 символа
  - Ограничение: Строка должна быть длиной минимум 2 символа.

- `phone`: Телефонный номер пользователя.
  - Тип: `string`
  - Ограничение: Должен быть действительным мобильным телефоном для региона 'ru-RU' (Россия).

- `email`: Электронная почта пользователя.
  - Тип: `string`
  - Ограничение: Не обязательное поле. Должно соответствовать шаблону электронного адреса.

- `password`: Пароль пользователя.
  - Тип: `string`
  - Минимальная длина: 8 символов
  - Ограничение: Опциональное поле. Если предоставлено, должно быть длиной минимум 8 символов.

### Валидация

Используется декораторы из пакета `class-validator` для валидации входящих данных:

- `@IsString()`: Поле должно быть строкой.
- `@MinLength()`: Минимальная длина строки.
- `@IsMobilePhone()`: Поле должно быть номером мобильного телефона.
- `@IsEmail()`: Поле должно быть адрессом электронной почты.
- `@IsOptional()`: Опциональное поле.

### Документация API

Используя `@ApiProperty()` из пакета `@nestjs/swagger`, каждому свойству присвоен тип для генерации соответствующей документации Swagger.


## UpdateUserDto

Содержит класс наследующий `CreateUserDto` для использования при обновлении данных пользователя.

### Свойства класса

Наследует поля суперкласса `CreateUserDto`, делая их опциональными. Позволяю передавать в запросах лишь данные, необходимы для обновления конкретных полей.
Поле `phone` исключено из данного класса.

## UserPayload

`UserPayload` — декоратор, переопределяющий стандартное поведение функции. Автоматически извлекает данные пользователя из объекта запроса (request).

### Использование

Декоратор применяется в контроллерах для получения данных пользователя, которые были прикреплены к запросу (по средствам middleware).
